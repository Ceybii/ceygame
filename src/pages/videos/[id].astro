---
import BaseLayout from '@layouts/BaseLayout.astro';
import Header from '@components/Header.astro';
import Footer from '@components/Footer.astro';
import { SITE_CONFIG } from '@lib/config';
---

<BaseLayout
  seo={{
    title: 'Video Yükleniyor...',
    description: 'Ceygame video içeriği',
  }}
>
  <Header />
  
  <main class="container mx-auto px-4 py-12">
    <div id="video-container">
      <!-- Loading state -->
      <div class="flex justify-center py-12">
        <div class="relative w-16 h-16">
          <div class="absolute top-0 left-0 w-full h-full border-4 border-accent/20 rounded-full"></div>
          <div class="absolute top-0 left-0 w-full h-full border-4 border-accent border-t-transparent rounded-full animate-spin"></div>
        </div>
      </div>
    </div>
  </main>

  <Footer />
</BaseLayout>

<script>
  import { fetchVideoById, formatDate } from '@lib/youtube';
  import { SITE_CONFIG } from '@lib/config';
  import { getVideoObjectSchema } from '@lib/seo';

  async function loadVideo() {
    const container = document.getElementById('video-container');
    if (!container) return;

    // Get video ID from URL
    const pathParts = window.location.pathname.split('/');
    const videoId = pathParts[pathParts.length - 1];

    if (!videoId) {
      container.innerHTML = `
        <div class="text-center py-12">
          <p class="text-gray-400">Video bulunamadı.</p>
        </div>
      `;
      return;
    }

    try {
      const video = await fetchVideoById(SITE_CONFIG.youtube.apiKey, videoId);

      if (!video) {
        container.innerHTML = `
          <div class="text-center py-12">
            <p class="text-gray-400">Video bulunamadı.</p>
            <a href="/videos" class="text-accent hover:underline mt-4 inline-block">Tüm Videolara Dön</a>
          </div>
        `;
        return;
      }

      // Update page title and meta
      document.title = `${video.title} | Ceygame`;
      const metaDescription = document.querySelector('meta[name="description"]');
      if (metaDescription) {
        metaDescription.setAttribute('content', video.description.slice(0, 160));
      }

      // Add VideoObject schema
      const schema = getVideoObjectSchema({
        name: video.title,
        description: video.description,
        thumbnailUrl: video.thumbnail,
        uploadDate: video.publishedAt,
        duration: video.duration,
        contentUrl: `https://www.youtube.com/watch?v=${video.id}`,
        embedUrl: `https://www.youtube.com/embed/${video.id}`
      }, SITE_CONFIG.url);

      const scriptTag = document.createElement('script');
      scriptTag.type = 'application/ld+json';
      scriptTag.textContent = JSON.stringify(schema);
      document.head.appendChild(scriptTag);

      // Render video page
      container.innerHTML = `
        <div class="max-w-5xl mx-auto">
          <!-- Video Player -->
          <div class="aspect-video bg-black rounded-lg overflow-hidden mb-6">
            <iframe
              src="https://www.youtube.com/embed/${video.id}"
              title="${video.title}"
              frameborder="0"
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
              allowfullscreen
              class="w-full h-full"
            ></iframe>
          </div>

          <!-- Video Info -->
          <div class="bg-dark-surface rounded-lg p-6 mb-6">
            <h1 class="text-3xl font-bold text-white mb-4">${video.title}</h1>
            
            <div class="flex flex-wrap items-center gap-4 text-gray-400 mb-4">
              <span class="flex items-center">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>
                ${formatDate(video.publishedAt)}
              </span>
              ${video.duration ? `
                <span class="flex items-center">
                  <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                  </svg>
                  ${video.duration}
                </span>
              ` : ''}
              ${video.viewCount ? `
                <span class="flex items-center">
                  <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                  </svg>
                  ${video.viewCount} görüntülenme
                </span>
              ` : ''}
              ${video.likeCount ? `
                <span class="flex items-center">
                  <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 20m7-10V5a2 2 0 00-2-2h-.095c-.5 0-.905.405-.905.905 0 .714-.211 1.412-.608 2.006L7 11v9m7-10h-2M7 20H5a2 2 0 01-2-2v-6a2 2 0 012-2h2.5"/>
                  </svg>
                  ${video.likeCount} beğeni
                </span>
              ` : ''}
            </div>

            <div class="flex flex-col sm:flex-row gap-4 mb-6">
              <a
                href="https://www.youtube.com/watch?v=${video.id}"
                target="_blank"
                rel="noopener noreferrer"
                class="inline-flex items-center justify-center px-6 py-3 bg-red-600 hover:bg-red-700 text-white rounded-lg font-semibold transition-colors"
              >
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>
                </svg>
                YouTube'da İzle
              </a>
              <a
                href="${SITE_CONFIG.social.youtube}"
                target="_blank"
                rel="noopener noreferrer"
                class="inline-flex items-center justify-center px-6 py-3 bg-dark-border hover:bg-dark-border/80 text-white rounded-lg font-semibold transition-colors"
              >
                Kanala Abone Ol
              </a>
            </div>

            ${video.description ? `
              <div class="border-t border-dark-border pt-4">
                <h2 class="text-xl font-semibold text-white mb-2">Açıklama</h2>
                <p class="text-gray-300 whitespace-pre-wrap">${video.description}</p>
              </div>
            ` : ''}
          </div>

          <!-- Back to Videos -->
          <div class="text-center">
            <a
              href="/videos"
              class="inline-flex items-center text-accent hover:underline"
            >
              <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
              </svg>
              Tüm Videolara Dön
            </a>
          </div>
        </div>
      `;
    } catch (error) {
      console.error('Failed to load video:', error);
      container.innerHTML = `
        <div class="bg-red-500/10 border border-red-500/50 rounded-lg p-6 text-center max-w-2xl mx-auto">
          <svg class="w-12 h-12 mx-auto text-red-500 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
          <h3 class="text-xl font-semibold text-white mb-2">Video Yüklenemedi</h3>
          <p class="text-gray-300 mb-4">Video bilgileri yüklenirken bir hata oluştu.</p>
          <div class="flex gap-4 justify-center">
            <button onclick="window.location.reload()" class="px-6 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-semibold transition-colors">Tekrar Dene</button>
            <a href="/videos" class="px-6 py-2 bg-dark-surface hover:bg-dark-border text-white rounded-lg font-semibold transition-colors">Tüm Videolara Dön</a>
          </div>
        </div>
      `;
    }
  }

  // Load video on page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', loadVideo);
  } else {
    loadVideo();
  }
</script>

